<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="title" content="Command Prompt">
  <meta name="description" content="A custom browser-based command prompt terminal.">
  <meta name="author" content="SlimeTube">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Command Prompt</title>
  <style>
    html, body { margin:0; padding:0; height:100%; background:#000; color:#fff; overflow:hidden;
      background-size:100% 100%; background-repeat:no-repeat; background-position:center center;
      background-attachment:fixed; font-family:'VGA',monospace; }
    #indicator { background:#222; color:#0f0; padding:5px 10px; font-size:12px; }
    #terminal { height:100vh; padding:10px 10px 60px; box-sizing:border-box; overflow-y:auto; white-space:pre-wrap; }
    #input-container { position:fixed; bottom:0; left:0; right:0; background:#111; padding:10px; display:flex; z-index:1000; }
    #input-prompt { margin-right:5px; }
    #input { flex:1; background:transparent; border:none; outline:none; color:white;
      font-family:'VGA',monospace; font-size:16px; }
    #username-viewer { position:fixed; bottom:10px; right:10px; color:#0f0; background:#222;
      padding:5px 10px; font-family:'VGA',monospace; font-size:14px; border-radius:4px; user-select:none; z-index:1100;}
    @font-face { font-family:'VGA'; src:url('https://slimetube.github.io/vga.ttf'); }
    noscript { color:red; background:black; display:block; padding:20px; font-family:sans-serif; }
    img.avatar-inline { width:32px; height:32px; vertical-align:middle; border-radius:50%; margin-right:5px; }
  </style>
</head>
<body>
<noscript>⚠ JavaScript is required. This terminal will not work without it.</noscript>
<div id="indicator"></div>
<div id="terminal"></div>
<div id="input-container">
  <span id="input-prompt">&gt;</span>
  <input id="input" autofocus spellcheck="false" />
</div>
<div id="username-viewer"></div>
<script type="module">
const terminal = document.getElementById('terminal');
const input = document.getElementById('input');
const indicator = document.getElementById('indicator');
const usernameViewer = document.getElementById('username-viewer');

const blockedWords = ['nigger','nigga','faggot','retard','asshole','fuck','shit','bitch','slut','cunt','porn','sex'];
const blockedDomains = ['cdn.discordapp.com','rule34','porn','hentai','xxx','adult'];
const rainbowColors = ['red','orange','yellow','green','blue','indigo','violet'];
const defaultPfps = [
  'https://i.imgur.com/D299rno.gif',
  'https://slimetube.github.io/src/carly.webp',
  'https://slimetube.github.io/src/sam.webp',
  'https://slimetube.github.io/src/fred.webp',
  'https://slimetube.github.io/src/spen.webp'
];
const defaultUsernames = ['bubble app','Hold Up','SillyBilly1234','iCarlyFan5465'];
const defaultWebhook = "https://discord.com/api/webhooks/1393396765012660224/weXmVY6hr6lu25FmDQnmmLSvjEcqnWH6LKGzku-aBI32C3uflaH7eu4sbICNv78HCVN-";

let username = localStorage.getItem('cmd_username') || defaultUsernames[Math.floor(Math.random()*defaultUsernames.length)];
let pfp = localStorage.getItem('cmd_pfp') || defaultPfps[Math.floor(Math.random()*defaultPfps.length)];
let webhook = localStorage.getItem('cmd_webhook') || defaultWebhook;
const history = JSON.parse(localStorage.getItem('cmd_history')||'[]');
let historyIndex = history.length;
indicator.textContent = `Platform: ${navigator.platform} | UA: ${navigator.userAgent}`;

function escapeHtml(text){ return String(text).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
function write(text,color){ const div=document.createElement('div'); div.innerHTML=text; if(color) div.style.color=color;
  terminal.appendChild(div); terminal.scrollTop=terminal.scrollHeight; }
function updateUsernameViewer(){ usernameViewer.textContent=`User: ${username}`; }
function isValidUrl(str){ try{new URL(str); return true;}catch{return false;} }

async function safeFetch(url){
  for(const d of blockedDomains){
    if(url.includes(d)){ write(`Blocked domain: ${d}`,'red'); throw ''; }
  }
  try {
    const r=await fetch(url);
    if(!r.ok) throw 'Failed';
    return r;
  } catch {
    write(`${url} failed due to CORS.`,'red'); throw '';
  }
}

async function getIPv4() {
  try {
    const res = await fetch("https://api.ipify.org?format=json");
    const data = await res.json();
    return data.ip;
  } catch {
    return null;
  }
}

async function checkBan(ip) {
  try {
    const res = await fetch("https://giggityfiles.github.io/terminalbans.json");
    const data = await res.json();

    const entries = (Array.isArray(data) ? data : []).map(entry => {
      if (typeof entry === "string") return { ip: entry, reason: "No reason given" };
      return entry;
    });

    const ipv4Entries = entries.filter(e => /^\d{1,3}(\.\d{1,3}){3}$/.test(e.ip));
    const match = ipv4Entries.find(e => e.ip === ip);

    if (match) {
      console.warn(`BANNED: ${match.ip} — Reason: ${match.reason}`);
      document.body.innerHTML = `
        <h1 style="color:red;background:black;padding:20px;">Access Denied</h1>
        <p style="color:white;background:black;padding:10px;">
          Your IP (${match.ip}) is banned.<br>
          Reason: ${escapeHtml(match.reason)}
        </p>
      `;
      throw new Error("Banned IP");
    }
  } catch (e) {
    console.error("Ban check failed", e);
  }
}

async function handlePipeline(cmdline){
  const segments = cmdline.split('|').map(s=>s.trim());
  let piped = '';
  for(const seg of segments){
    piped = await runCommand(seg,piped);
  }
}

async function runCommand(cmd,piped=''){
  const parts = cmd.trim().split(' ');
  const base = parts[0].toLowerCase();
  let out='';
  if(base==='clear'){ terminal.innerHTML=''; }
  else if(base==='help'){
    write(`Commands:
clear, help, echo, curl, swapbg, fontswap, theme, speak,
platform, useragent, date, username, webhook, resethook, pfp, dump, bart,
ai, open, littlecaesars, dscrd, unixtime, music, stop, ghls, js, css, discordinfo`);
  }
  else if(base==='echo'){
    out = escapeHtml(parts.slice(1).join(' ') || piped);
    write(out);
  }
  else if(base==='curl'){
    const url = parts[1];
    if(!url) return write('Usage: curl <url>');
    const r=await safeFetch(url);
    const txt=await r.text();
    const isHtml = txt.trim().toLowerCase().startsWith('<!doctype html') || txt.trim().toLowerCase().startsWith('<html');
    out = isHtml ? escapeHtml(txt) : txt;
    write(out);
  }
  else if(base==='swapbg'){
    document.body.style.backgroundColor=parts[1]||'#000';
    document.body.style.backgroundImage=parts[2]?`url(${parts[2]})`:'';
    document.body.style.backgroundSize='100% 100%';
    write(`Background updated`);
  }
  else if(base==='fontswap'){
    const url=parts[1];
    if(!url) return write('Usage: fontswap <url>');
    const name=url.split('/').pop().split('.')[0];
    const style=document.createElement('style');
    style.textContent=`@font-face{font-family:'${name}';src:url('${url}')}body,input{font-family:'${name}'}`;
    document.head.appendChild(style);
    write(`Font changed to ${name}`);
  }
  else if(base==='theme'){
    const th=parts[1];
    if(th==='aero') document.body.style.background='#000';
    if(th==='adult'){ document.body.style.background='#000'; document.body.style.color='#fff'; }
    if(th==='slime'){
      document.body.style.backgroundImage='url(https://pbs.twimg.com/media/FcZKJ0bXgAAPqDF?format=png)';
      document.body.style.backgroundSize='100% 100%';
    }
    write(`Theme ${th} applied`);
  }
  else if(base==='speak'){
    const t=parts.slice(1).join(' ')||piped;
    if(t) speechSynthesis.speak(new SpeechSynthesisUtterance(t));
  }
  else if(base==='platform') write(navigator.platform);
  else if(base==='useragent') write(navigator.userAgent);
  else if(base==='date') write(new Date().toString());
  else if(base==='username'){
    const newName=parts.slice(1).join(' ');
    if(blockedWords.some(w=> newName.toLowerCase().includes(w))) return write('Blocked word!');
    username=newName; localStorage.setItem('cmd_username',username);
    updateUsernameViewer(); write(`Username set to ${username}`);
  }
  else if(base==='webhook'){
    const newHook=parts[1];
    if(newHook){ webhook=newHook; localStorage.setItem('cmd_webhook',webhook); write('Webhook updated.'); }
    else write(`Current webhook: ${webhook}`);
  }
  else if(base==='resethook'){
    webhook=defaultWebhook; localStorage.setItem('cmd_webhook',webhook); write('Webhook reset to default.');
  }
  else if(base==='pfp'){
    const newUrl=parts[1];
    if(newUrl){
      if(blockedWords.some(w=> newUrl.toLowerCase().includes(w))) return write('Blocked!');
      pfp=newUrl; localStorage.setItem('cmd_pfp',pfp);
      write(`Profile picture updated.`);
    } else {
      write(`Current PFP: ${pfp}`);
    }
  }
  else if(base==='dump'){
    const all = Array.from(terminal.children).map(e=> e.textContent.replace(/^>\s/,'')).join('\n');
    const blob=new Blob([all],{type:'text/plain'});
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob); a.download='dump.pegx'; a.click();
    write('Dump saved.');
  }
  else if(base==='bart'){
    const text="Eat my shorts!";
    const div=document.createElement('div');
    div.innerHTML=[...text].map((l,i)=> `<span style="color:${rainbowColors[i%rainbowColors.length]}">${l}</span>`).join('');
    terminal.appendChild(div); terminal.scrollTop=terminal.scrollHeight;
  }
  else if(base==='ai'){
    const q=parts.slice(1).join(' ')||piped;
    const r=await safeFetch(`https://text.pollinations.ai/${encodeURIComponent(q)}`);
    const t=await r.text(); write(t);
  }
  else if(base==='open'){
    const url=parts[1]||piped;
    if(!url) return write('Usage: open <url>');
    window.open(url,'_blank','width=800,height=600,resizable=yes'); write(`Opened ${url}`);
  }
  else if(base==='littlecaesars'){
    write('Pizza Pizza!');
    await fetch(webhook,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({
        content:`Pizza Pizza! ${username} activated Little Caesars!`,username:username,avatar_url:pfp
      })
    });
  }
  else if(base==='dscrd'){
    const msg=parts.slice(1).join(' ')||piped;
    if(blockedWords.some(w=> msg.toLowerCase().includes(w))) return write('Blocked!');
    await fetch(webhook,{
      method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({content:msg,username:username,avatar_url:pfp})
    });
    write('Sent!');
  }
  else if(base==='unixtime'){
    const num=Number(parts[1]); if(isNaN(num)) return write('Usage: unixtime <number>');
    const d=new Date(num*1000); write(`${num} => ${d.toUTCString()} | ${d.toString()}`);
  }
  else if(base==='music'){
    const url=parts[1]; if(!url) return write('Usage: music <audio file URL>');
    if(musicAudio){ musicAudio.pause(); musicAudio=null; }
    musicAudio=new Audio(url); musicAudio.loop=true;
    musicAudio.play().catch(()=> write('Failed to play audio.'));
    write(`Playing music from: ${url} (looping)`);
  }
  else if(base==='stop'){
    if(musicAudio){ musicAudio.pause(); musicAudio=null; write('Music stopped.'); }
    else write('No music is playing.');
  }
  else if(base==='ghls'){
    if(parts.length<3) return write('Usage: ghls <user> <repo> [path]');
    const user=parts[1], repo=parts[2], path=parts.slice(3).join(' ')||'';
    await listGhls(user, repo, path);
  }
  else if(base==='js'){
    let code = parts.slice(1).join(' ');
    if(!code) return write('Usage: js <code or URL>');
    if(isValidUrl(code)){
      write(`Fetching JavaScript from URL: ${code}`);
      try { const res=await fetch(code); code=await res.text(); }
      catch{ return; }
    }
    try{
      const originalLog=console.log;
      console.log=(...args)=>{ write('[log] '+args.join(' '),'#0f0'); originalLog(...args); };
      write('Evaluating JavaScript...');
      eval(code);
      console.log=originalLog;
    }catch(e){ write('JS Error: '+e.message,'red'); }
  }
  else if(base==='css'){
    let css = parts.slice(1).join(' ');
    if(!css) return write('Usage: css <style rules or URL>');
    if(isValidUrl(css)){
      write(`Fetching CSS from URL: ${css}`);
      try { const res=await fetch(css); css=await res.text(); }
      catch{ return; }
    }
    const style=document.createElement('style'); style.textContent=css; document.head.appendChild(style);
    write('CSS applied.');
  }
  else if(base==='discordinfo'){
    const guildId = parts[1];
    if(!guildId) return write('Usage: discordinfo <guild_id>');
    const url = `https://discord.com/api/guilds/${guildId}/widget.json`;
    try {
      const res = await fetch(url);
      if(!res.ok) throw `HTTP ${res.status}`;
      const data = await res.json();
      if(!data.members){ write('No members or widget not enabled.', 'red'); return; }
      write(`Online members in guild ${escapeHtml(data.name||guildId)} (Total: ${data.members.length}):`);
      data.members.forEach(m=>{
        const username = escapeHtml(String(m.username||''));
        const status = escapeHtml(String(m.status||''));
        const gameText = m.game && m.game.name ? ` — Playing: ${escapeHtml(String(m.game.name))}` : '';
        const avatarImg = m.avatar ? `<img class="avatar-inline" src="${m.avatar}" />` : '';
        write(`${avatarImg}${username} — ${status}${gameText}`);
      });
    } catch(err){ write(`Failed to fetch discordinfo: ${err}`, 'red'); }
  }
  else write('Unknown command');
  return out;
}

input.addEventListener('keydown', e=>{
  if(e.key==='Enter'){
    const cmd=input.value.trim();
    if(cmd){
      history.push(cmd); localStorage.setItem('cmd_history',JSON.stringify(history));
      handlePipeline(cmd); input.value=''; historyIndex=history.length;
    }
  }
  else if(e.key==='ArrowUp'){
    if(historyIndex>0) input.value=history[--historyIndex];
    e.preventDefault();
  }
  else if(e.key==='ArrowDown'){
    if(historyIndex<history.length-1) input.value=history[++historyIndex];
    else input.value='', historyIndex=history.length;
    e.preventDefault();
  }
});

updateUsernameViewer();

(async () => {
  const ip = await getIPv4();
  if (ip) {
    write(`Your IPv4: ${ip}`);
    indicator.textContent += ` | IPv4: ${ip}`;
    await checkBan(ip);
  } else {
    write("Could not detect IPv4 address.");
  }
})();

// Always show welcome
write(`Welcome ${username}! Type "help" to see commands.`);

// Run commands from URL if provided (?cmd=echo%20hi;help)
const params = new URLSearchParams(window.location.search);
if (params.has('cmd')) {
  const cmdsFromUrl = decodeURIComponent(params.get('cmd'));
  if (cmdsFromUrl) {
    const cmdList = cmdsFromUrl.split(';').map(c => c.trim()).filter(Boolean);
    (async () => {
      for (const c of cmdList) {
        write('> ' + c);
        await handlePipeline(c);
      }
    })();
  }
}
</script>
</body>
</html>
